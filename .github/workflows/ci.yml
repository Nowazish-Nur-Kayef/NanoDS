name: CI

on: 
  push:
    branches:  [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================================================
  # Multi-Platform Build & Test
  # ============================================================================
  build-and-test: 
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix. os }}
    
    strategy: 
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cc: gcc
          - os:  macos-latest
            cc:  clang
          - os: windows-latest
            cc: gcc
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup GCC (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install:  >-
          mingw-w64-x86_64-gcc
          make
    
    - name: Build test suite (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        ${{ matrix.cc }} -std=c11 -Wall -Wextra -O2 test.c -o nanods_test
      shell: bash
    
    - name: Build test suite (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        gcc -std=c11 -Wall -Wextra -O2 test.c -o nanods_test.exe
    
    - name: Run tests (Unix)
      if: matrix.os != 'windows-latest'
      run: ./nanods_test
      shell: bash
    
    - name: Run tests (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: ./nanods_test.exe
    
    - name: Build benchmark (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        ${{ matrix.cc }} -std=c11 -Wall -Wextra -O2 benchmark.c -o nanods_benchmark
      shell: bash
    
    - name: Build benchmark (Windows)
      if: matrix.os == 'windows-latest'
      shell:  msys2 {0}
      run: |
        gcc -std=c11 -Wall -Wextra -O2 benchmark.c -o nanods_benchmark.exe
    
    - name: Run benchmark (Unix)
      if: matrix.os != 'windows-latest'
      run: ./nanods_benchmark
      shell: bash
    
    - name: Run benchmark (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: ./nanods_benchmark.exe

  # ============================================================================
  # Memory Leak Check (Valgrind - Linux only)
  # ============================================================================
  memory-check:
    name: Memory Leak Check (Valgrind)
    runs-on: ubuntu-latest
    
    steps:
    - name:  Checkout code
      uses:  actions/checkout@v4
    
    - name: Install Valgrind
      run: sudo apt-get update && sudo apt-get install -y valgrind
    
    - name: Build with debug symbols
      run: gcc -std=c11 -Wall -Wextra -g -O0 test.c -o nanods_test
    
    - name: Run Valgrind
      run: |
        valgrind --leak-check=full \
                 --show-leak-kinds=all \
                 --track-origins=yes \
                 --error-exitcode=1 \
                 ./nanods_test

  # ============================================================================
  # Hard Safety Mode Test
  # ============================================================================
  hard-safety-test:
    name:  Hard Safety Mode Test
    runs-on: ubuntu-latest
    
    steps: 
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build with hard safety
      run: gcc -std=c11 -Wall -Wextra -DNANODS_HARD_SAFETY -O2 test.c -o nanods_test_safe
    
    - name:  Run hard safety tests
      run:  ./nanods_test_safe

  # ============================================================================
  # Compiler Compatibility Check
  # ============================================================================
  compiler-compat:
    name: Compiler Compatibility (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    
    strategy: 
      fail-fast: false
      matrix:
        compiler: 
          - gcc-11
          - gcc-12
          - clang-14
          - clang-15
    
    steps: 
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name:  Install compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.compiler }}
    
    - name: Build
      run: ${{ matrix.compiler }} -std=c11 -Wall -Wextra -O2 test.c -o nanods_test
    
    - name:  Run tests
      run: ./nanods_test

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage: 
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install gcov/gcovr
      run: sudo apt-get update && sudo apt-get install -y gcovr
    
    - name:  Build with coverage
      run: gcc -std=c11 -Wall -Wextra --coverage -O0 test.c -o nanods_test
    
    - name: Run tests
      run: ./nanods_test
    
    - name: Generate coverage report
      run: |
        gcovr --print-summary
        gcovr --txt coverage.txt
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.txt

  # ============================================================================
  # Performance Baseline
  # ============================================================================
  performance-check: 
    name: Performance Baseline
    runs-on: ubuntu-latest
    
    steps: 
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name:  Build benchmark
      run: gcc -std=c11 -Wall -Wextra -O3 -march=native benchmark.c -o nanods_benchmark
    
    - name: Run benchmark
      run: ./nanods_benchmark | tee benchmark_results.txt
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmark_results. txt
