name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request: 
    branches: [ main ]

jobs:
  # ============================================================================
  # Multi-Platform Build & Test
  # ============================================================================
  build-and-test: 
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix. os }}
    
    strategy:
      fail-fast: false
      matrix: 
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            cc: gcc
          - os: macos-latest
            cc: clang
          - os: windows-latest
            cc: gcc
    
    steps:
    - name: Checkout code
      uses:  actions/checkout@v4
    
    - name: Setup GCC (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with: 
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          make
    
    - name: Build test suite (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        ${{ matrix.cc }} -std=c11 -Wall -Wextra -O2 test.c -o nanods_test
      shell: bash
    
    - name: Build test suite (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        gcc -std=c11 -Wall -Wextra -O2 test.c -o nanods_test.exe
    
    - name: Run tests (Unix)
      if: matrix.os != 'windows-latest'
      run: ./nanods_test
      shell: bash
    
    - name: Run tests (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: ./nanods_test.exe

  # ============================================================================
  # Build Examples
  # ============================================================================
  build-examples:
    name:  Build Examples (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses:  actions/checkout@v4
    
    - name: Setup GCC (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
    
    - name: Build word frequency (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        gcc -std=c11 -Wall -Wextra -O2 examples/word_frequency.c -o word_frequency
        ./word_frequency
      shell: bash
    
    - name: Build word frequency (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        gcc -std=c11 -Wall -Wextra -O2 examples/word_frequency.c -o word_frequency.exe
        ./word_frequency.exe
    
    - name: Build command history (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        gcc -std=c11 -Wall -Wextra -O2 examples/command_history.c -o command_history
        ./command_history
      shell: bash
    
    - name:  Build command history (Windows)
      if: matrix.os == 'windows-latest'
      shell:  msys2 {0}
      run: |
        gcc -std=c11 -Wall -Wextra -O2 examples/command_history.c -o command_history.exe
        ./command_history.exe

  # ============================================================================
  # Build Benchmarks
  # ============================================================================
  build-benchmarks: 
    name: Build Benchmarks (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os:  [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout code
      uses:  actions/checkout@v4
    
    - name: Setup GCC (Windows)
      if: matrix.os == 'windows-latest'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-gcc
    
    - name: Build and run benchmarks (Unix)
      if: matrix.os != 'windows-latest'
      run:  |
        gcc -std=c11 -Wall -Wextra -O3 -march=native benchmarks/bench_vector.c -o bench_vector
        gcc -std=c11 -Wall -Wextra -O3 -march=native benchmarks/bench_map.c -o bench_map
        gcc -std=c11 -Wall -Wextra -O3 -march=native benchmarks/bench_comparison.c -o bench_comparison
        ./bench_vector
        ./bench_map
        ./bench_comparison
      shell: bash
    
    - name: Build and run benchmarks (Windows)
      if: matrix.os == 'windows-latest'
      shell: msys2 {0}
      run: |
        gcc -std=c11 -Wall -Wextra -O3 benchmarks/bench_vector.c -o bench_vector.exe
        gcc -std=c11 -Wall -Wextra -O3 benchmarks/bench_map.c -o bench_map.exe
        gcc -std=c11 -Wall -Wextra -O3 benchmarks/bench_comparison.c -o bench_comparison.exe
        ./bench_vector.exe
        ./bench_map.exe
        ./bench_comparison.exe

  # ============================================================================
  # Memory Leak Check (Valgrind - Linux only)
  # ============================================================================
  memory-check:
    name: Memory Leak Check (Valgrind)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses:  actions/checkout@v4
    
    - name: Install Valgrind
      run: sudo apt-get update && sudo apt-get install -y valgrind
    
    - name: Build with debug symbols
      run: gcc -std=c11 -Wall -Wextra -g -O0 test.c -o nanods_test
    
    - name: Run Valgrind
      run: |
        valgrind --leak-check=full \
                 --show-leak-kinds=all \
                 --track-origins=yes \
                 --error-exitcode=1 \
                 ./nanods_test

  # ============================================================================
  # Hard Safety Mode Test
  # ============================================================================
  hard-safety-test:
    name: Hard Safety Mode Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build with hard safety
      run: gcc -std=c11 -Wall -Wextra -DNANODS_HARD_SAFETY -O2 test.c -o nanods_test_safe
    
    - name: Run hard safety tests
      run: ./nanods_test_safe

  # ============================================================================
  # Compiler Compatibility Check
  # ============================================================================
  compiler-compat:
    name: Compiler Compatibility (${{ matrix.compiler }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        compiler: 
          - gcc-11
          - gcc-12
          - clang-14
          - clang-15
    
    steps: 
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.compiler }}
    
    - name: Build
      run: ${{ matrix.compiler }} -std=c11 -Wall -Wextra -O2 test.c -o nanods_test
    
    - name: Run tests
      run:  ./nanods_test

  # ============================================================================
  # CMake Build Test
  # ============================================================================
  cmake-build: 
    name: CMake Build (${{ matrix.os }})
    runs-on: ${{ matrix. os }}
    
    strategy: 
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name:  Checkout code
      uses: actions/checkout@v4
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1
      with:
        cmake-version: '3.20.x'
    
    - name:  Configure CMake (Unix)
      if: matrix.os != 'windows-latest'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
    
    - name: Configure CMake (Windows)
      if: matrix.os == 'windows-latest'
      run: cmake -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Run tests
      run: ctest --test-dir build --output-on-failure

  # ============================================================================
  # Bundle Script Test
  # ============================================================================
  bundle-test:
    name:  Test Bundle Script
    runs-on:  ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Run bundle script
      run: python3 scripts/bundle.py
    
    - name:  Verify bundled file exists
      run: test -f nanods_bundled.h
    
    - name: Test bundled file compiles
      run: |
        echo '#define NANODS_IMPLEMENTATION' > test_bundle.c
        echo '#include "nanods_bundled.h"' >> test_bundle.c
        echo 'int main(void) { IntVector v; nv_init_int(&v); nv_free_int(&v); return 0; }' >> test_bundle.c
        gcc -std=c11 -Wall -Wextra test_bundle.c -o test_bundle
        ./test_bundle

  # ============================================================================
  # Code Coverage
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install gcov/gcovr
      run: sudo apt-get update && sudo apt-get install -y gcovr
    
    - name: Build with coverage
      run: gcc -std=c11 -Wall -Wextra --coverage -O0 test.c -o nanods_test
    
    - name: Run tests
      run: ./nanods_test
    
    - name: Generate coverage report
      run: |
        gcovr --print-summary
        gcovr --txt coverage.txt
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name:  coverage-report
        path: coverage.txt

  # ============================================================================
  # Performance Baseline
  # ============================================================================
  performance-check:
    name: Performance Baseline
    runs-on: ubuntu-latest
    
    steps: 
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name:  Build benchmarks
      run: |
        gcc -std=c11 -Wall -Wextra -O3 -march=native benchmarks/bench_vector.c -o bench_vector
        gcc -std=c11 -Wall -Wextra -O3 -march=native benchmarks/bench_map.c -o bench_map
    
    - name: Run benchmarks
      run: |
        ./bench_vector | tee bench_vector_results.txt
        ./bench_map | tee bench_map_results.txt
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: |
          bench_vector_results.txt
          bench_map_results.txt
